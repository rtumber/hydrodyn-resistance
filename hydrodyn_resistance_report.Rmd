---
title: Prediction of Residual Resistance from various Hull Geometry Coefficients and
  Froude Number
author: "R Tumber"
date: "19/10/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```{r load_libs, echo= FALSE, include=FALSE}
library(tidyverse)
library(data.table)
library(tinytex)
```

```{r load_rdata, echo= FALSE, message=FALSE}
load("../Project 2/hydrodyn.RData")
```

### Introduction
The project was performed on the dataset produced from a series of experiments that took place at the Delft Ship Hydromechanics Laboratory. The goal was to predict the value of residual resistance using a variety of hull geometry coefficients and Froude number as accurately as possible.
The dataset was downloaded from the UCI Machine Learning Laboratory and then imported, the information for the column names came from scraping the html page and extracting the relevant information. Since the column names were longer than ideal they were shortened, with the definitions stored in a separate table

```{r attribute_definitions, echo=FALSE}
print(att_inf)
```

The dataset consisted of 308 instances of 7 attributes:

```{r data_summary_intro, echo=FALSE}
str(import_data[1:5,])
```

All attributes were numerical and there were no missing entries in the dataset. The variable to predict was the Residuary resistance per unit weight of displacement.

In examining the data, each variable was plotted against the residual resistance to determine if there were any obvious correlations and the correlation coefficients calculated. Following this, a correlation and covariance matrix was produced, looking for relationships not seen in the visualisations.
The only variable showing a clear relationship was the Froude number.
Where no clear relationship was observed, further visualisations were made using the average residual resistance at different values of variables to attempt to identify a weak relationship, here, the Prismatic Coefficient showed a possible relationship. 
The Froude number was then examined more closely, the observed exponential style curve was straightened to allow the option of modelling using a linear regression approach.

Finally, the variables that did not show an relationship were examined in the light of the equations used to calculated them and the variables already identified as having an effect on residual resistance.

It was decided that all variables should, in theory, have an effect on the residual resistance.

Before modelling, the data were split into a training and test set.
Initially, two models were built using Caret to predict residual resistance from Froude Number only and then with the Prismatic Coefficient, using two separate ensembles, one using linear regression methods and the log of the Froude Number and the other using non-linear regression methods. Model accuracy was assessed using RMSE as this could be applied to be both model types.

The more sucessful, non-linear regression model was kept and within this model the Random Forest type method was most accurate. As a result, a new ensemble was put together with a selection of Random Forest Type methods, and the generated models assessed again, with the most accurate two being carried forward. At this stage each of the remaining variables was added one at a time and only where RMSE was improved was the variable set aside to add at the end.
Only one other variable had a beneficial effect on model accuracy, Length-Displacement Ratio. This was added to the model before tuning.
The tuned values were used to produce a model from which predictied values were generated from the test set and a final RMSE calcualted.

***

### Method and Analysis

#### Downloading and wrangling the dataset
The Yacht Hydrodynamics dataset URL was downloaded from the UCI Machine Learning Laboratory and imported as a data table with no column headers. The column headers were scraped from the UCI page for that dataset (https://archive.ics.uci.edu/ml/datasets/Yacht+Hydrodynamics) the html manually inspected, split with '>' for easier viewing and the table containing the required data isolated as a list. This list was then then split and saved as a data table before a series of edits to this data table left it in a position in which to extract the column names. This data was tidied further with one more split, saved as a new object and a regex used to remove superfluous information. Pertinent information conerning the nature of the dataset was contained in this object so it was extracted and saved for use elsewhere.
These remaining data were set as the column names to the imported dataset.

#### Investigating the dataset structure
According to data scraped from the UCI Machine Learening Repository, variables 1-6 are described by the information previously retained from the attribute names object
```{r variables_defined, echo=FALSE}
print(att_1_6)
```
The seventh variable is that we looked to predict, dscribed by the second retained data object
```{r variables_defined, echo=FALSE}
print(att_7)
```
Variables 1-6 would now be explored in relation to variable 7 however, before proceeding the column names were shortened to aid clarity and the attribute information object used for the column names was repurposed as a key.

```{r attribute_definitions, echo=FALSE}
print(att_inf)
```

#### Exploring the data
```{r data_summary_intro, echo=FALSE}
str(import_data[1:5,])
```
The dataset structure showed it contained 308 observations of seven variables, all numeric. The variable to predict was the Residual Resistance per Unit Weight of Displacement and there were no missing values.

To begin the investigation the mean and standard deviation of the target variable were ascertained.
```{r resid_reswei_mean_sd, echo=FALSE}
import_data %>% summarize(mean = mean(resid_reswei), std_dev = sd(resid_reswei))
```
The variation in the values indicates either there are one or more factors in the dataset that influence the residual resistance by weight, the factors that influence the residual resistance are not in the dataset or that the values are random.
By looking at the other factors in the dataset we will attempt to determine which, if any, of them influence the result. Starting from the first and working through we look at how the residual resistance changes with each factor value.

1. Longitudinal position of the center of buoyancy, lcb.
```{r lcb_resid_reswei_plot, echo=FALSE}
import_data %>%
  group_by(lcb) %>%
  summarise(resid_reswei) %>%
  ggplot(aes(lcb, resid_reswei)) +
  geom_point()
```
The plot shows while there are few different values for the Longitudinal position of the center of buoyancy, for each one there are many different residual resistance values. Additionally there appear to be some clusters of values, a possible indication of a relationship with another factor or factors. One final note on this chart, it looks like no matter the value of Longitudinal Position, the residual resistance values tend to be closer to zero  and not down to random variation.

2. Prismatic coefficient, cp
```{r cp_resid_reswei_plot, echo=FALSE}
import_data %>%
  group_by(cp) %>%
  summarise(resid_reswei) %>%
  ggplot(aes(cp, resid_reswei)) +
  geom_point()
```
3. Length-displacement ratio, dlr
```{r dlr_resid_reswei_plot, echo=FALSE}
import_data %>%
  group_by(dlr) %>%
  summarise(resid_reswei) %>%
  ggplot(aes(dlr, resid_reswei)) +
  geom_point()
```
4. Beam-draft ratio, bt
```{r bt_resid_reswei_plot, echo=FALSE}
import_data %>%
  group_by(bt) %>%
  summarise(resid_reswei) %>%
  ggplot(aes(bt, resid_reswei)) +
  geom_point()
```
5. Length-beam ratio, lb
```{r lb_resid_reswei_plot, echo=FALSE}
import_data %>%
  group_by(lb) %>%
  summarise(resid_reswei) %>%
  ggplot(aes(lb, resid_reswei)) +
  geom_point()
```
The four scatterplots above for the second to fifth variables follow a similar pattern as that for the first, a range of residual resistances for individual variable values with no obvious correlation observed and residual resistances being weighted towards zero. The clustering observed in the first plot persists and could be argued to be down to the controlled variation in experimental values used in the course of data gathering.

6. Froude number, fn
```{r fn_resid_reswei_plot, echo=FALSE}
import_data %>%
  group_by(fn) %>%
  summarise(resid_reswei) %>%
  ggplot(aes(fn, resid_reswei)) +
  geom_point()
```
This plot appears to show this variable as having a bearing on the residual resistance. The shape could be related to the equation by which the froude number is calculated.
$$Fr_{l} = u/\sqrt{gL_{wl}}$$
It could be the square root element that is influencing the shape when the equation is rearranged away from Froude number as the subject. It should be noted, there is still variation in residual resistance for identical Froude numbers, indicating this is likely not the only factor to influence the residual resistance. So, while the plots for the previous factors did not give any strong indications of a relationship with the residual resistance, they should not be discounted entirely.

Correlation values calculated for the above variables confirm as is observed in the scatterplots, there is no direct relationship between the variables on their own and the residual resistance with the exception of the final variable, the Froude Number.

A correlation and covariance matrix was constructed to assess relationships between factors and residual resistance to look for any relationships not seen by comparing individual factors to the residual resistance. For reference, the correlation values for the individual factors against residual resistance are also seen here.

Correlation
```{r cor_matr, echo=FALSE}
cor(import_data) %>% round(digits = 2)
```
Covariance
```{r cov_matr, echo=FALSE}
cov(import_data) %>% round(digits = 2)
```

For the most part there was little observed in the way of correlation and covariance between the factors and the residual resistance, with the exception of the Froude number, which we already identified as being significant. This result does not assist in explaining the variation in residual resistance for a constant Froude Number. However, in order for the experiment data to be at all useful we must assume that all parameters, with the exception of those in the import_data set, have remained the same so the variation observed must either be down to random variation or down to one, some or all of the remaining factors.

With the above in mind the average residual resistance for each factor value was taken and the results plotted to determine if a weak relationship could be observed.

1. Longitudinal position of the center of buoyancy
```{r lcb_mean_resid_reswei_plot, echo=FALSE}
import_data %>%
  group_by(lcb) %>%
  summarise(res = mean(resid_reswei)) %>%
  ggplot(aes(lcb, res)) +
  geom_point()
```
2. Prismatic coefficient
```{r cp_mean_resid_reswei_plot, echo=FALSE}
import_data %>%
  group_by(cp) %>%
  summarise(res = mean(resid_reswei)) %>%
  ggplot(aes(cp, res)) +
  geom_point()
```
3. Length-displacement ratio
```{r dllr_mean_resid_reswei_plot, echo=FALSE}
import_data %>%
  group_by(dlr) %>%
  summarise(res = mean(resid_reswei)) %>%
  ggplot(aes(dlr, res)) +
  geom_point()
```
4. Beam-draft ratio
```{r bt_mean_resid_reswei_plot, echo=FALSE}
import_data %>%
  group_by(bt) %>%
  summarise(res = mean(resid_reswei)) %>%
  ggplot(aes(bt, res)) +
  geom_point()
```
5. Length-beam ratio
```{r lb_mean_resid_reswei_plot, echo=FALSE}
import_data %>%
  group_by(lb) %>%
  summarise(res = mean(resid_reswei)) %>%
  ggplot(aes(lb, res)) +
  geom_point()
```

An examination of the graphs only produced an indication of a possible relationship between the Prismatic coefficient and the residual resistance. While not entirely clear, further support for a relationship between the Prismatic Coeffecient and the residual resistance can be found by looking at the equations for both the Prismatic Coefficient, which may show a relationship, and the Froude number, which displays a strong relataionship.
The equation for calculating the Prismatic Coefficient is 

$$C_{p} = V/L_{wl} A_{m}$$

where $C_{p}$ is the Prismatic Coefficient, V is Volume, $L_{wl}$ is length at the waterline and $A_{m}$ is Cross sectional area.

The equation for calculating the Froude number is
$$Fr_{l} = u/\sqrt{gL_{wl}}$$
where $Fn_{l}$ is the Froude Number, u is relative flow velocity, g is the acceleration due to gravity and $L_{wl}$ is length at the waterline.
Since u is not defined we must consider it constant as we must with g. This means the only remaining part of the equation for calculating the Froude Number is $L_{wl}$ and must have a bearing on residual resistance.

Relating this to Prismatic coefficient we see $L_{wl}$ is a common factor in the above equations, so where there is a relationship with residual resistance for one factor, it is likely to continue for another.
For this reason this factor will be included in creating a prediction model.


Returning to the Froude Number/residual resistance plot data, the mean and standard deviation of the residual resistance for each Froude number was calculated and plotted. The idea being to simplify the plot and illustrate any irregularities in the data points. The below plot demonstrates no such iregularities were found, the resistance values remained exponential and the standard deviation appeared almost linear, in line with expectations.
```{r froude_mean_sd_res_plot, echo=FALSE}
froude_data <- import_data %>%
  group_by(fn) %>%
  summarise(resid_reswei)

froude_data <- froude_data %>%
  group_by(fn) %>%
  summarise(mean_res = mean(resid_reswei), sd_res = sd(resid_reswei))

froude_data %>%
  gather(stat, val, 'mean_res', 'sd_res') %>%
  ggplot() +
  geom_point(aes(fn, val, color = stat))
```
The residual resistance plot is non linear so it presents us two options when it comes to modelling. Either use a 
non-linear regression method or attempt to straighten the curve and factor this into a linear regression model. 

The curve is partially straightened, producing a linear relationship, by using log values of Froude number to predict log values of Residual Resistance. While not completely straight it was decided this could prove a useful approximation given it would be unlikely for the this process to produce a straight line where there are other influences on the residual resistance.

```{r log_froude_log_mean_res_plot, *echo=FALSE}
froude_data %>% mutate(log_fn= log(fn), log_res= log(mean_res)) %>%
  ggplot() +
  geom_point(aes(log_fn, log_res))
```

Before proceeding to modelling it is important to return to the four factors that did not appear to have any relationship with the residual resistance. It should first be noted for all factors the number of data points was low, making it challenging to observe any relationships. While it was not possible to determine a definite relationship with the remaining factors, we should not discount them from further analysis, the reasons for which are outlined below.

Factor 1. Longitudinal position of the center of buoyancy, lcb.
The longitudinal centre of buoyancy is at the centre of the underwater volume, that is, the volume of the hull that lies beneath the waterline. Since this relates to volume below the waterline it could be argued that the length of
the hull at the waterline is important which may indicate a relationship with resistance as it has previously.

Factor 3. Length-displacement ratio, dlr
The length-displacement ratio describes how heavy a craft is in relation to its length at the waterline. Defined as $$dlr = (displacement(lb)/2240) / ((0.01*L_{wl})^3)$$
$L_{wl}$, length at the waterline once again has a bearing on the calculated value, in the same way it does for Prismatic Coefficient and Froude Number.

Factor 4. Beam-draft ratio, bt
It would be unwise to pivot all arguements solely on the length of a hull at the waterline. The beam-draft ratio,
the ratio of the beam, the width of the ship at the widest point at the waterline, and the draft, the distance
between the waterline and deepest part of the hull, provides us a rough idea of the cross sectional area of submerged hull. If we look back to the equation for calculating the Prismatic Coefficient, $C_{p} = V/L_{wl} A_{m}$, $A_m$ represented the cross sectional area. While this by no means proves a link to the residual resistance, it could be argued that there are reasonable grounds to consider the Beam-draft ratio as having some influence.

Factor 5. Length-beam ratio, lb
The Length-beam ratio describes the rough shape of the hull at the waterline. If we consider the length at the #waterline and the beam measurement in the context of the other dataset factors, and we are happy that they, in part or as a whole contribute to the residual resistance, it must follow that this ratio also has an effect.


With the above in mind we were left with a choice, produce a model that discounts these factors, based on a lack of evidence, a model that includes all these factors or produce a model that adds them stepwise and retaining more control over the training.

It was decided the structured approach would be to first model the factors Froude Number followed by Prismatic Coefficient using three different linear regression models, followed by three models that do not use linear regression. At each stage the performance of the models would be assessed and after modelling Prismatic coefficient, the best performing retained.
Following this, the remaining factors, lcb, dlr, bt and lb, would be added individually one at a time, assess model performance and remove the factors again as appropriate.
Once all factors that improve model accuracy are isolated, the model hyperparameters would then be tuned.

The assessment of the models would be based on the RMSE, on the bases that it can be applied and to both linear and non-linear regression models allowing for direct comparison of model performance, and that it can be applied to continuous data.

#### Model Creation and Testing

Before model building could begin, a training and test set was created.
Since the dataset was small a 80/20 train/test split was used along with k-fold cross validation on the training set to improve accuracy before assessing the model on the test set. 10 fold cross validation with 20% sections of the training data was applied to strike a balance between having a sample size that is not too closely related to the full training data set, overtraining and processing time.

The following model types were used, grouped as linear and non-linear and saved as character objects, to first get an idea of accuracy as these represent a reasonable overview of the different models available to us, before moving forward with the more sucessful of these models.
* Linear regression models
  + lm
  + glm
  + svmLinear
* Non-linear regression models
  + svmPoly
  + knn
  + RRF

```{r model_ens, *eval=FALSE}
lr_model_ens <- c("lm", "glm", "svmLinear")
nlr_model_ens <- c("svmPoly", "knn", "RRF")
```
10-fold cross validation to be used in training was defined
```{r 10_cv_def, *eval=FALSE}
control <- trainControl(method = "cv", number = 10, p = 0.8)
```
The model name was added to the training function to guage progress and identify any potential bottlenecks, the defined cross validation control was added and for the linear regression models, log values for fn and resid_reswei are used. Before training, the seed was set to ensure models use the same cross validation samples.
The training function was first applied to the Froude Number.
```{r lr_init_model, *eval=FALSE}
set.seed(1, sample.kind="Rounding")
lr_fits <- lapply(lr_model_ens, function(model){ 
  print(model)
  train(log(resid_reswei) ~ log(fn), method = model, data = res_train, trControl = control)
})
```
The RMSE for each method was then calculated. It should be noted the RMSE generated by the fit was that for log residual resistance and needed converting back to resistance.

```{r lr_init_rmses, *eval=FALSE}
n_models <- seq(1:3)
lr_rmses <- sapply(n_models, function(m_number){
  lr_fits[[m_number]][["results"]][["RMSE"]]
})

lr_rmses <- as.data.frame(lr_rmses) %>%
  mutate(model_name = lr_model_ens)
colnames(lr_rmses) <- c("RMSE", "model_name")
lr_rmses <- lr_rmses %>%
  mutate(adjusted_RMSE = exp(RMSE))
```
This was repeated but with the Prismatic Coefficient added.
```{r lr_fr_cp, *eval=FALSE}
set.seed(1, sample.kind="Rounding")
lr_fits_cp <- lapply(lr_model_ens, function(model){ 
  print(model)
  train(log(resid_reswei) ~ log(fn) + cp, method = model, data = res_train, trControl = control)
})

lr_rmses_cp <- sapply(n_models, function(m_number){
  lr_fits_cp[[m_number]][["results"]][["RMSE"]]
})

lr_rmses_cp <- as.data.frame(lr_rmses_cp) %>%
  mutate(model_name = lr_model_ens)
colnames(lr_rmses_cp) <- c("RMSE", "model_name")
lr_rmses_cp <- lr_rmses_cp %>%
  mutate(adjusted_RMSE = exp(RMSE))
```
When both sets of RMSEs were examined there was no great difference made by adding the prismatic coefficient to the models, with one of the three models tested producing a worse RMSE. This may reflect the observations made in exploring the data, where the relationship between Prismatic Coefficient and Residual Resistance was not necessarily clear.
* Froude Number Only
```{r lr_fn_rmses, *echo=FALSE}
print(lr_rmses)
```
* Froude Number with Prismatic Coefficient
```{r lr_fn_cp_rmses, *echo=FALSE}
print(lr_rmses_cp)
```



## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
